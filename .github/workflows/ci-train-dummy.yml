name: ci-train-dummy

on:
  push:
    branches: ["**"]
  pull_request:

jobs:
  train-dummy:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install base deps
        run: |
          python -m pip install -U pip setuptools wheel
          # requirements.txt 里不应包含 torch（CPU/GPU分离安装），但即使包含也没关系：我们下面强制装 CPU torch
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install torch --index-url https://download.pytorch.org/whl/cpu
          # 项目可编辑安装，确保 src/ 下模块能 import
          pip install -e .

      - name: Sanity import
        run: |
          python -c "import emfm.nf; import ttt; print('import ok')"

      - name: Run dummy training (CPU)
        run: |
          python scripts/train.py --config configs/inversion/nf_inversion_dummy_ci.yaml
